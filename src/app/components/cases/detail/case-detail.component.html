<div class="bg-white dark:bg-gray-800 shadow rounded-lg ">
  <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
    <!-- Izquierda: Título -->
    <h2 class="text-lg font-semibold text-[#00113f] dark:text-white">
      Caso #{{ caseData.case_id }}
    </h2>

    <!-- Derecha: Botones -->
    <div class="flex gap-2">
      <button (click)="closeCase()" class="px-3 py-1 rounded bg-red-600 text-white text-sm hover:bg-red-700">
        Cerrar Caso
      </button>
      <button (click)="goBack()"
        class="px-3 py-1 rounded bg-gray-400 text-sm hover:bg-gray-800 dark:bg-gray-700 dark:text-white">
        Volver
      </button>
    </div>
  </div>

  <div class="p-4 space-y-4">
    <!-- Información básica -->
    <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
      <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex items-center justify-between">

        <!-- Texto a la izquierda -->
        <div class="text-sm font-semibold text-[#00113f] dark:text-white flex-1">
          Cliente
        </div>

        <!-- Botones a la derecha -->
        <div class="flex gap-2">
          <button id="new-client" class="chip-btn" (click)="addNewClient()">Nuevo cliente</button>

          @if (caseData.client_name) {
          <button class="chip-btn" (click)="openAssignClientModal()">Cambiar</button>
          } @else {
          <button class="chip-btn" (click)="openAssignClientModal()">Asignar</button>
          }
        </div>
      </div>
 
      <div class="p-4">
        @if (caseData.client_name) {
        <div class="flex items-center gap-3">
          <div
            class="h-10 w-10 rounded-full bg-blue-800 dark:bg-blue-800 flex items-center justify-center text-sm font-semibold text-white">
            {{ (currentClient?.full_name || 'C')[0] || 'C' }}
          </div>
          <div class="min-w-0">
            <div class="text-sm text-[#00113f] dark:text-gray-100 truncate">
              {{ currentClient?.full_name }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              Identificación: {{currentClient?.external_id }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              Teléfono: {{currentClient?.phone }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              Email: {{currentClient?.email }}
            </div>
          </div>
        </div>
        } @else {
        <div class="text-sm text-gray-500 dark:text-gray-400">
          Este caso aún no está vinculado a un cliente.
        </div>
        }
      </div>
    </div>


    <div class="text-sm text-gray-500">Departamento</div>
    <div class="text-base">{{ caseData.department_name }}</div>

    <div>
      <div class="text-sm text-gray-500">Canal</div>
      <div class="text-base">{{ caseData.channel_name }}</div>
    </div>

    <div>
      <div class="text-sm text-gray-500">Etapa actual</div>
      <div class="text-base">{{ currentCaseFunnel?.current_stage_name }}</div>
    </div>

    <!-- Acciones de stage -->
    <div class="flex gap-3">
      <button (click)="moveToStage(2)" class="px-3 py-1 rounded bg-blue-600 text-white text-sm">
        Mover a Stage 2
      </button>
    </div>

    <!-- Notas -->
    <div>
      <div class="text-sm font-semibold mb-2">Notas</div>
      <textarea [(ngModel)]="newNote" rows="2" placeholder="Añadir nota..."
        class="w-full border rounded-md px-2 py-1"></textarea>
      <button (click)="addNote()" [disabled]="isSavingNote || !newNote.trim()"
        class="mt-2 px-3 py-1 rounded bg-[#00113f] text-white text-sm">
        {{ isSavingNote ? 'Guardando...' : 'Añadir' }}
      </button>

      <div *ngFor="let n of notes" class="mt-2 border-t pt-2">
        <div class="text-xs text-gray-500">{{ n.created_at | date:'short' }}</div>
        {{ n.note }}
      </div>
    </div>
  </div>

  <!-- Formulario de cliente -->
  <app-client-form *ngIf="isFormOpen" [client]="currentClient" (success)="onSuccess($event)" (cancel)="closeDialog()">
  </app-client-form>


  <!-- Modal de asignación de cliente -->

<!-- ========== MODAL ASIGNAR/CAMBIAR CLIENTE ========== -->
@if (isAssignClientOpen) {
<div class="fixed inset-0 z-[60]" (click)="closeAssignClientModal()">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60"></div>

    <!-- Contenedor centrado -->
    <div class="absolute inset-0 flex items-center justify-center p-4" (click)="$event.stopPropagation()">
        <!-- Caja del modal: altura máx + layout en columna -->
        <div
            class="w-full max-w-3xl max-h-[85vh] bg-white dark:bg-gray-900 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col">

            <!-- Header (fijo) -->
            <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
                <div class="text-sm font-semibold text-[#00113f] dark:text-white">
                    Asignar cliente al caso
                </div>
                <button class="chip-btn" (click)="closeAssignClientModal()">Cerrar</button>
            </div>

            <!-- Body (scroll propio) -->
            <div class="flex-1 min-h-0 overflow-y-auto px-4 py-3 space-y-3">
                <!-- Buscador -->
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </span>
                    <input [(ngModel)]="clientSearch" (ngModelChange)="onClientSearchChange($event)" type="text"
                        placeholder="Buscar por nombre…" class="pl-9 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400
                   focus:outline-none focus:ring-2 focus:ring-[#3e66ea] focus:border-transparent
                   text-sm text-[#00113f] dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
                </div>

                <!-- Estados -->
                @if (isLoadingClients) {
                <div class="text-sm text-gray-500 dark:text-gray-400">Cargando clientes…</div>
                } @else if (filteredClients.length === 0) {
                <div class="text-sm text-gray-500 dark:text-gray-400">Sin resultados.</div>
                }

                <!-- Resultados (scroll propio) -->
                @if (filteredClients.length > 0) {
                <div class="max-h-[50vh] overflow-y-auto rounded-md border border-gray-200 dark:border-gray-800">
                    @for (cli of filteredClients; track cli.id) {
                    <button (click)="selectClientCandidate(cli)" class="w-full text-left px-4 py-3 border-b last:border-b-0 border-gray-100 dark:border-gray-800
                       hover:bg-gray-50/60 dark:hover:bg-gray-800/60 focus:outline-none flex items-center gap-3"
                        [ngClass]="{ 'bg-[#e8efff]': selectedClientCandidate?.id === cli.id }">

                        <div class="h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center
                         text-sm font-semibold text-gray-600 dark:text-gray-200">
                            {{ cli.full_name?.[0] || 'C' }}
                        </div>

                        <div class="min-w-0">
                            <div class="text-sm font-medium text-[#00113f] dark:text-white truncate">
                                {{ cli.full_name }}
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                                {{ cli.email || '—' }} · {{ cli.phone || '—' }}
                            </div>
                        </div>
                    </button>
                    }
                </div>
                }
            </div>

            <!-- Footer (fijo) -->
            <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-800 flex items-center justify-end gap-2">

                <button
                    class="px-4 py-2 rounded-md text-sm font-medium text-white bg-[#00113f] hover:bg-[#3e66ea] disabled:opacity-50"
                    [disabled]="!selectedClientCandidate || isAssigningClient" (click)="confirmAssignClient()">
                    {{ isAssigningClient ? 'Asignando…' : 'Asignar' }}
                </button>
            </div>

        </div>
    </div>
</div>

}<!-- ========== FIN MODAL ASIGNAR/CAMBIAR CLIENTE ========== -->

</div>