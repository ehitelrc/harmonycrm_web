<div class="bg-white dark:bg-gray-800 shadow rounded-lg ">
  <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
    <!-- Izquierda: Título -->
    <h2 class="text-lg font-semibold text-[#00113f] dark:text-white">
      Caso #{{ caseData.case_id }}
    </h2>

    <!-- Derecha: Botones -->
    <div class="flex gap-2 close-case-button">
      <button (click)="closeCase()" class="chip-btn bg-red-600 text-white text-sm hover:bg-red-700 ">
        Cerrar Caso
      </button>
      <button (click)="goBack()" class="chip-btn">
        Volver
      </button>
    </div>
  </div>

  <div class="p-4 space-y-4">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Left column: Client info -->
      <div>
        <!-- Información básica -->
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
          <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex items-center justify-between">

            <!-- Texto a la izquierda -->
            <div class="text-sm font-semibold text-[#00113f] dark:text-white flex-1">
              Cliente
            </div>

            <!-- Botones a la derecha -->
            <div class="flex gap-2">
              <button id="new-client" class="chip-btn" (click)="addNewClient()">Nuevo cliente</button>

              @if (caseData.client_name) {
              <button class="chip-btn" (click)="openAssignClientModal()">Cambiar</button>
              } @else {
              <button class="chip-btn" (click)="openAssignClientModal()">Asignar</button>
              }
            </div>
          </div>

          <div class="p-4">
            @if (caseData.client_name) {
            <div class="flex items-center gap-3">
              <div
                class="h-10 w-10 rounded-full bg-blue-800 dark:bg-blue-800 flex items-center justify-center text-sm font-semibold text-white">
                {{ (currentClient?.full_name || 'C')[0] || 'C' }}
              </div>
              <div class="min-w-0">
                <div class="text-sm text-[#00113f] dark:text-gray-100 truncate">
                  {{ currentClient?.full_name }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  Identificación: {{currentClient?.external_id }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  Teléfono: {{currentClient?.phone }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  Email: {{currentClient?.email }}
                </div>
              </div>
            </div>
            } @else {
            <div class="text-sm text-gray-500 dark:text-gray-400">
              Este caso aún no está vinculado a un cliente.
            </div>
            }
          </div>
        </div>

        <br>
        <!-- Tarjeta Campaña -->
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
          <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex items-center justify-between">
            <!-- Título -->
            <div class="text-sm font-semibold text-[#00113f] dark:text-white flex-1">
              Campaña
            </div>

            <!-- Botón asignar -->
            <div class="flex gap-2">
              <button class="chip-btn" (click)="openAssignCampaignModal()">Asignar campaña</button>
            </div>
          </div>

          <div class="p-4">
            @if (caseData.campaign_name) {
            <div class="flex items-center gap-3">
              <div
                class="h-10 w-10 rounded-full bg-purple-700 dark:bg-purple-800 flex items-center justify-center text-sm font-semibold text-white">
                {{ (caseData.campaign_name || 'C')[0] || 'C' }}
              </div>
              <div class="min-w-0">
                <div class="text-sm text-[#00113f] dark:text-gray-100 truncate">
                  {{ caseData.campaign_name }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  ID: {{ caseData.campaign_id }}
                </div>
              </div>
            </div>
            } @else {
            <div class="text-sm text-gray-500 dark:text-gray-400">
              Este caso aún no tiene campaña asignada.
            </div>
            }
          </div>
        </div>

        <br>

        <!-- Notas -->
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
          <div
            class="p-4 border-b border-gray-100 dark:border-gray-800 text-sm font-semibold text-[#00113f] dark:text-white">
            Notas
          </div>
          <div class="p-4 space-y-3">
            <textarea [(ngModel)]="newNote" rows="2" placeholder="Añadir nota..."
              class="w-full border rounded-md px-2 py-1"></textarea>
            <button (click)="addNote()" [disabled]="isSavingNote || !newNote.trim()"
              class="mt-2 px-3 py-1 rounded bg-[#00113f] text-white text-sm">
              {{ isSavingNote ? 'Guardando...' : 'Añadir' }}
            </button>

            <div *ngFor="let n of notes" class="mt-2 border-t pt-2">
              <div class="text-xs text-gray-500">{{ n.created_at | date:'short' }}</div>
              {{ n.note }}
            </div>
          </div>
        </div>
      </div>

      <!-- Right column: Department, Canal, Etapa actual -->
      <div class="space-y-4">



        <!-- Tarjeta Etapa actual -->
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
          <!-- Encabezado con fondo azul tenue -->
          <div
            class="p-4 border-b border-gray-100 dark:border-gray-800 flex items-center justify-between bg-blue-50 dark:bg-blue-900/30">
            <div class="text-sm font-semibold text-[#00113f] dark:text-white flex-1">
              Etapa actual
            </div>

            <!-- Botón mover stage -->
            <div class="flex gap-2">
              <button class="chip-btn" (click)="openChangeStatusModal(caseData.case_id)">Cambiar etapa</button>
            </div>
          </div>

          <div class="p-4 space-y-3">
            <!-- Pill dinámico con color desde color_hex -->
            <span class="inline-block px-3 py-1 text-sm font-medium rounded-full text-white"
              [style.backgroundColor]="caseData.color_hex || '#2563eb'">
              {{ currentCaseFunnel?.current_stage_name || 'Sin etapa' }}
            </span>

            <!-- Info adicional con label -->
            <div>
              <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">
                Último cambio realizado por
              </div>
              <div class="text-base text-[#00113f] dark:text-gray-100">
                <strong>{{ currentCaseFunnel?.last_changed_by_label || '—' }}</strong>
                <i class="text-sm text-gray-500 dark:text-gray-400">
                  ({{ currentCaseFunnel?.last_changed_at | date:'short' }})
                </i>
              </div>
            </div>
          </div>
        </div>

        <!-- Departamento -->
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
          <div class="p-4 border-b border-gray-100 dark:border-gray-800 text-sm font-semibold 
              text-[#00113f] dark:text-white flex items-center justify-between">
            <span>Departamento</span>
            <button class="chip-btn" (click)="openAssignDepartmentModal()">Asignar departamento</button>
          </div>
          <div class="p-4 text-base text-[#00113f] dark:text-gray-100">
            {{ caseData.department_name || 'Sin departamento' }}
          </div>
        </div>

        <!-- Tarjeta Agente asignado -->
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
          <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex items-center justify-between">
            <!-- Título -->
            <div class="text-sm font-semibold text-[#00113f] dark:text-white flex-1">
              Agente asignado
            </div>

            <!-- Botón asignar -->
            <div class="flex gap-2">
              <button class="chip-btn" (click)="openAssignAgentModal()">Asignar agente</button>
            </div>
          </div>

          <div class="p-4">
            @if (caseData.agent_name) {
            <div class="flex items-center gap-3">
              <div
                class="h-10 w-10 rounded-full bg-green-700 dark:bg-green-800 flex items-center justify-center text-sm font-semibold text-white">
                {{ (caseData.agent_name || 'A')[0] || 'A' }}
              </div>
              <div class="min-w-0">
                <div class="text-sm text-[#00113f] dark:text-gray-100 truncate">
                  {{ caseData.agent_name }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  ID: {{ caseData.agent_id }}
                </div>
              </div>
            </div>
            } @else {
            <div class="text-sm text-gray-500 dark:text-gray-400">
              Este caso aún no tiene un agente asignado.
            </div>
            }
          </div>
        </div>

        <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
          <div
            class="p-4 border-b border-gray-100 dark:border-gray-800 text-sm font-semibold text-[#00113f] dark:text-white">
            Canal
          </div>
          <div class="p-4 text-base text-[#00113f] dark:text-gray-100">
            {{ caseData.channel_name }}
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- Formulario de cliente -->
  <app-client-form *ngIf="isFormOpen" [client]="currentClient" (success)="onSuccess($event)" (cancel)="closeDialog()">
  </app-client-form>


  <!-- ========== MODAL VINCULAR CAMPAÑA ========== -->
  @if (isAssignCampaignOpen) {
  <div class="fixed inset-0 z-[60]" (click)="closeAssignCampaignModal()">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60"></div>

    <!-- Contenedor centrado -->
    <div class="absolute inset-0 flex items-center justify-center p-4" (click)="$event.stopPropagation()">
      <!-- Caja del modal -->
      <div
        class="w-full max-w-3xl max-h-[85vh] bg-white dark:bg-gray-900 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col">

        <!-- Header -->
        <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
          <div class="text-sm font-semibold text-[#00113f] dark:text-white">
            Vincular a campaña
          </div>
          <button class="chip-btn" (click)="closeAssignCampaignModal()">Cerrar</button>
        </div>

        <!-- Body -->
        <div class="flex-1 min-h-0 overflow-y-auto px-4 py-3 space-y-3">
          <!-- Buscador -->
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </span>
            <input [(ngModel)]="campaignSearch" (ngModelChange)="onCampaignSearchChange($event)" type="text"
              placeholder="Buscar campaña…" class="pl-9 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400
                   focus:outline-none focus:ring-2 focus:ring-[#3e66ea] focus:border-transparent
                   text-sm text-[#00113f] dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
          </div>

          <!-- Estados -->
          @if (isLoadingCampaigns) {
          <div class="text-sm text-gray-500 dark:text-gray-400">Cargando campañas…</div>
          } @else if (filteredCampaigns.length === 0) {
          <div class="text-sm text-gray-500 dark:text-gray-400">Sin resultados.</div>
          }

          <!-- Resultados -->
          @if (filteredCampaigns.length > 0) {
          <div class="max-h-[50vh] overflow-y-auto rounded-md border border-gray-200 dark:border-gray-800">
            @for (camp of filteredCampaigns; track camp.campaign_id) {
            <button (click)="selectCampaignCandidate(camp)" class="w-full text-left px-4 py-3 border-b last:border-b-0 border-gray-100 dark:border-gray-800
                       hover:bg-gray-50/60 dark:hover:bg-gray-800/60 focus:outline-none flex items-center gap-3"
              [ngClass]="{ 'bg-[#e8efff]': selectedCampaignCandidate?.campaign_id === camp.campaign_id }">

              <div class="h-10 w-10 rounded-full bg-indigo-200 dark:bg-indigo-700 flex items-center justify-center
                            text-sm font-semibold text-indigo-900 dark:text-white">
                {{ (camp.campaign_name || 'C')[0] }}
              </div>

              <div class="min-w-0">
                <div class="text-sm font-medium text-[#00113f] dark:text-white truncate">
                  {{ camp.campaign_name }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                  {{ camp.start_date || '—' }} — {{ camp.end_date || '—' }}
                  <span class="ml-2" [class]="camp.is_active ? 'text-green-600' : 'text-gray-500'">
                    {{ camp.is_active ? 'Activa' : 'Inactiva' }}
                  </span>
                </div>
                <div class="text-xs text-gray-400 dark:text-gray-500 truncate">
                  Embudo: {{ camp.funnel_name || '—' }}
                </div>
              </div>
            </button>
            }
          </div>
          }
        </div>

        <!-- Footer -->
        <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-800 flex items-center justify-end gap-2">
          <button
            class="px-4 py-2 rounded-md text-sm font-medium text-white bg-[#00113f] hover:bg-[#3e66ea] disabled:opacity-50"
            [disabled]="!selectedCampaignCandidate || isAssigningCampaign" (click)="confirmAssignCampaign()">
            {{ isAssigningCampaign ? 'Vinculando…' : 'Vincular' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  }





  <!-- ========== MODAL ASIGNAR/CAMBIAR CLIENTE ========== -->
  @if (isAssignClientOpen) {
  <div class="fixed inset-0 z-[60]" (click)="closeAssignClientModal()">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60"></div>

    <!-- Contenedor centrado -->
    <div class="absolute inset-0 flex items-center justify-center p-4" (click)="$event.stopPropagation()">
      <!-- Caja del modal: altura máx + layout en columna -->
      <div
        class="w-full max-w-3xl max-h-[85vh] bg-white dark:bg-gray-900 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col">

        <!-- Header (fijo) -->
        <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
          <div class="text-sm font-semibold text-[#00113f] dark:text-white">
            Asignar cliente al caso
          </div>
          <button class="chip-btn" (click)="closeAssignClientModal()">Cerrar</button>
        </div>

        <!-- Body (scroll propio) -->
        <div class="flex-1 min-h-0 overflow-y-auto px-4 py-3 space-y-3">
          <!-- Buscador -->
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </span>
            <input [(ngModel)]="clientSearch" (ngModelChange)="onClientSearchChange($event)" type="text"
              placeholder="Buscar por nombre…" class="pl-9 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400
                   focus:outline-none focus:ring-2 focus:ring-[#3e66ea] focus:border-transparent
                   text-sm text-[#00113f] dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
          </div>

          <!-- Estados -->
          @if (isLoadingClients) {
          <div class="text-sm text-gray-500 dark:text-gray-400">Cargando clientes…</div>
          } @else if (filteredClients.length === 0) {
          <div class="text-sm text-gray-500 dark:text-gray-400">Sin resultados.</div>
          }

          <!-- Resultados (scroll propio) -->
          @if (filteredClients.length > 0) {
          <div class="max-h-[50vh] overflow-y-auto rounded-md border border-gray-200 dark:border-gray-800">
            @for (cli of filteredClients; track cli.id) {
            <button (click)="selectClientCandidate(cli)" class="w-full text-left px-4 py-3 border-b last:border-b-0 border-gray-100 dark:border-gray-800
                       hover:bg-gray-50/60 dark:hover:bg-gray-800/60 focus:outline-none flex items-center gap-3"
              [ngClass]="{ 'bg-[#e8efff]': selectedClientCandidate?.id === cli.id }">

              <div class="h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center
                         text-sm font-semibold text-gray-600 dark:text-gray-200">
                {{ cli.full_name?.[0] || 'C' }}
              </div>

              <div class="min-w-0">
                <div class="text-sm font-medium text-[#00113f] dark:text-white truncate">
                  {{ cli.full_name }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                  {{ cli.email || '—' }} · {{ cli.phone || '—' }}
                </div>
              </div>
            </button>
            }
          </div>
          }
        </div>

        <!-- Footer (fijo) -->
        <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-800 flex items-center justify-end gap-2">

          <button
            class="px-4 py-2 rounded-md text-sm font-medium text-white bg-[#00113f] hover:bg-[#3e66ea] disabled:opacity-50"
            [disabled]="!selectedClientCandidate || isAssigningClient" (click)="confirmAssignClient()">
            {{ isAssigningClient ? 'Asignando…' : 'Asignar' }}
          </button>
        </div>

      </div>
    </div>
  </div>

  }



  <!-- ========== MODAL VINCULAR DEPARTAMENTO ========== -->
  @if (isAssignDepartmentOpen) {
  <div class="fixed inset-0 z-[60]" (click)="closeAssignDepartmentModal()">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60"></div>

    <!-- Contenedor centrado -->
    <div class="absolute inset-0 flex items-center justify-center p-4" (click)="$event.stopPropagation()">
      <!-- Caja -->
      <div
        class="w-full max-w-3xl max-h-[85vh] bg-white dark:bg-gray-900 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col">

        <!-- Header -->
        <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
          <div class="text-sm font-semibold text-[#00113f] dark:text-white">
            Asignar departamento
          </div>
          <button class="chip-btn" (click)="closeAssignDepartmentModal()">Cerrar</button>
        </div>

        <!-- Body -->
        <div class="flex-1 min-h-0 overflow-y-auto px-4 py-3 space-y-3">
          <!-- Buscador -->
          <input [(ngModel)]="departmentSearch" (ngModelChange)="onDepartmentSearchChange($event)" type="text"
            placeholder="Buscar departamento…" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                 focus:outline-none focus:ring-2 focus:ring-[#3e66ea] focus:border-transparent
                 text-sm text-[#00113f] dark:bg-gray-800 dark:border-gray-700 dark:text-white" />

          <!-- Estados -->
          @if (isLoadingDepartments) {
          <div class="text-sm text-gray-500 dark:text-gray-400">Cargando departamentos…</div>
          } @else if (filteredDepartments.length === 0) {
          <div class="text-sm text-gray-500 dark:text-gray-400">Sin resultados.</div>
          }

          <!-- Resultados -->
          @if (filteredDepartments.length > 0) {
          <div class="max-h-[50vh] overflow-y-auto rounded-md border border-gray-200 dark:border-gray-800">
            @for (dep of filteredDepartments; track dep.id) {
            <button (click)="selectDepartmentCandidate(dep)" class="w-full text-left px-4 py-3 border-b last:border-b-0 border-gray-100 dark:border-gray-800
                   hover:bg-gray-50/60 dark:hover:bg-gray-800/60 focus:outline-none flex items-center gap-3"
              [ngClass]="{ 'bg-[#e8efff]': selectedDepartmentCandidate?.id === dep.id }">

              <div class="h-10 w-10 rounded-full bg-indigo-200 dark:bg-indigo-700 flex items-center justify-center
                          text-sm font-semibold text-indigo-900 dark:text-white">
                {{ (dep.description || 'D')[0] }}
              </div>

              <div class="min-w-0">
                <div class="text-sm font-medium text-[#00113f] dark:text-white truncate">
                  {{ dep.description }}
                </div>
              </div>
            </button>
            }
          </div>
          }
        </div>

        <!-- Footer -->
        <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-800 flex items-center justify-end gap-2">
          <button
            class="px-4 py-2 rounded-md text-sm font-medium text-white bg-[#00113f] hover:bg-[#3e66ea] disabled:opacity-50"
            [disabled]="!selectedDepartmentCandidate || isAssigningDepartment" (click)="confirmAssignDepartment()">
            {{ isAssigningDepartment ? 'Asignando…' : 'Asignar' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  }


  <!-- ========== MODAL ASIGNAR AGENTE ========== -->
  @if (isAssignAgentOpen) {
  <div class="fixed inset-0 z-[60]" (click)="closeAssignAgentModal()">
    <div class="absolute inset-0 bg-black/60"></div>

    <div class="absolute inset-0 flex items-center justify-center p-4" (click)="$event.stopPropagation()">
      <div
        class="w-full max-w-3xl max-h-[85vh] bg-white dark:bg-gray-900 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col">

        <!-- Header -->
        <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
          <div class="text-sm font-semibold text-[#00113f] dark:text-white">
            Asignar agente al caso
          </div>
          <button class="chip-btn" (click)="closeAssignAgentModal()">Cerrar</button>
        </div>

        <!-- Body -->
        <div class="flex-1 min-h-0 overflow-y-auto px-4 py-3 space-y-3">
          <!-- Buscador -->
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </span>
            <input [(ngModel)]="agentSearch" (ngModelChange)="onAgentSearchChange($event)" type="text"
              placeholder="Buscar agente…" class="pl-9 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400
                   focus:outline-none focus:ring-2 focus:ring-[#3e66ea] focus:border-transparent
                   text-sm text-[#00113f] dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
          </div>

          <!-- Estados -->
          @if (isLoadingAgents) {
          <div class="text-sm text-gray-500 dark:text-gray-400">Cargando agentes…</div>
          } @else if (filteredAgents.length === 0) {
          <div class="text-sm text-gray-500 dark:text-gray-400">Sin resultados.</div>
          }

          <!-- Resultados -->
          @if (filteredAgents.length > 0) {
          <div class="max-h-[50vh] overflow-y-auto rounded-md border border-gray-200 dark:border-gray-800">
            @for (ag of filteredAgents; track ag.agent_id) {
            <button (click)="selectAgentCandidate(ag)" class="w-full text-left px-4 py-3 border-b last:border-b-0 border-gray-100 dark:border-gray-800
                       hover:bg-gray-50/60 dark:hover:bg-gray-800/60 focus:outline-none flex items-center gap-3"
              [ngClass]="{ 'bg-[#e8efff]': selectedAgentCandidate?.agent_id === ag.agent_id }">

              <img *ngIf="ag.profile_image_url" [src]="ag.profile_image_url"
                class="h-10 w-10 rounded-full object-cover" />
              <div *ngIf="!ag.profile_image_url"
                class="h-10 w-10 rounded-full bg-green-200 dark:bg-green-700 flex items-center justify-center text-sm font-semibold text-green-900 dark:text-white">
                {{ (ag.agent_name || 'A')[0] }}
              </div>

              <div class="min-w-0">
                <div class="text-sm font-medium text-[#00113f] dark:text-white truncate">
                  {{ ag.agent_name }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                  {{ ag.department_name }}
                </div>
              </div>
            </button>
            }
          </div>
          }
        </div>

        <!-- Footer -->
        <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-800 flex items-center justify-end gap-2">
          <button
            class="px-4 py-2 rounded-md text-sm font-medium text-white bg-[#00113f] hover:bg-[#3e66ea] disabled:opacity-50"
            [disabled]="!selectedAgentCandidate || isAssigningAgent" (click)="confirmAssignAgent()">
            {{ isAssigningAgent ? 'Asignando…' : 'Asignar' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  }

</div>

<app-move-stage-modal
  [isOpen]="isMoveStageOpen"
  [caseId]="caseData.case_id"
  [current]="currentStage!"
  (cancel)="isMoveStageOpen = false"
  (moved)="onMoveStage($event)">
</app-move-stage-modal>