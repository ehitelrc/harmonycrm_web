@if (!isCaseMode) {
<div class="h-[calc(100vh-2rem)] w-full bg-white dark:bg-gray-900 rounded-xl shadow-lg overflow-hidden flex">

    <!-- ========== Columna izquierda: contactos/casos ========== -->
    <aside class="w-full sm:w-80 lg:w-96 border-r border-gray-200 dark:border-gray-800 flex flex-col">
        <div class="p-4">
            <div *ngIf="!preSelectedCase" class="flex items-center gap-2 mb-3">
                <button type="button"
                    class="inline-flex items-center justify-center   w-8 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300"
                    (click)="goBack()" aria-label="Regresar" title="Regresar">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>

                <div class="text-base font-semibold text-[#00113f] dark:text-white">
                    Conversaciones
                </div>
            </div>

        </div>
        <div class="px-4 py-3">
            <div class="relative">
                <input [(ngModel)]="searchContact" (ngModelChange)="applyContactFilter()" type="text"
                    placeholder="Buscar contacto o #caso" class="w-full pl-9 pr-4 py-2 bg-gray-100 dark:bg-gray-800 border-none rounded-lg
                           text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500
                           focus:ring-2 focus:ring-[#3e66ea]/20 focus:bg-white dark:focus:bg-gray-700
                           transition-all duration-200 outline-none" />

                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </span>
            </div>
        </div>

        <!-- BOTÃ“N NUEVA CONVERSACIÃ“N -->
        <div class="px-4 mt-2">
            <button (click)="openNewConversationModal()" class="w-full flex items-center justify-center gap-2 py-2.5 
               rounded-xl bg-[#00113f] hover:bg-[#3e66ea] 
               text-white text-sm font-semibold shadow-md transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
                Nueva conversaciÃ³n
            </button>
        </div>

        <div class="flex-1 overflow-y-auto">


            <ng-container *ngIf="!isLoadingCases; else leftLoading">

                <button *ngFor="let c of filteredCases" [class.highlight]="c._highlight" (click)="selectCase(c)"
                    class="w-full text-left px-4 py-3 border-b border-gray-100 dark:border-gray-800 
                           hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200 cursor-pointer group relative">

                    <!-- Unread Indicator Line -->
                    <div *ngIf="c.unread_count && c.unread_count > 0"
                        class="absolute left-0 top-0 bottom-0 w-1 bg-[#3e66ea]"></div>

                    <div class="flex items-start gap-3">

                        <!-- Icono del canal -->
                        <div class="relative shrink-0">
                            <img [src]="channelIcon(c.channel_code!)" alt="canal"
                                class="h-10 w-10 rounded-full object-cover bg-white p-0.5 shadow-sm border border-gray-100 dark:border-gray-700" />

                            <span *ngIf="c.is_non_commercial"
                                class="absolute -bottom-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-blue-100 border border-white dark:border-gray-900"
                                title="No comercial">
                                <span class="text-[8px]">ðŸ’¼</span>
                            </span>
                        </div>

                        <!-- Contenido -->
                        <div class="flex-1 min-w-0">
                            <!-- Header Row: Name & Time -->
                            <div class="flex items-center justify-between mb-0.5">
                                <span class="text-sm font-semibold text-gray-900 dark:text-white truncate pr-2">
                                    {{ c.client_name || 'Desconocido' }}
                                </span>
                                <span *ngIf="c.last_message_at" class="text-[10px] text-gray-400 shrink-0">
                                    {{ c.last_message_at | date:'dd/MM/yyyy HH:mm' }}
                                </span>
                            </div>

                            <!-- Subheader Row: Last Message & Unread Badge -->
                            <div class="flex items-center justify-between gap-2">
                                <div
                                    class="text-xs text-gray-500 dark:text-gray-400 truncate group-hover:text-gray-700 dark:group-hover:text-gray-300 transition-colors">
                                    <span *ngIf="c.sender_id" class="text-gray-400 mr-1">@</span>{{
                                    c.last_message_preview || 'Nueva conversaciÃ³n' }}
                                </div>

                                <span *ngIf="c.unread_count && c.unread_count > 0" class="unread-badge shadow-sm">
                                    {{ c.unread_count }}
                                </span>
                            </div>

                            <!-- Integration Tag (Mini) -->
                            <div *ngIf="c.integration_name" class="mt-1 flex">
                                <span
                                    class="text-[9px] px-1.5 py-0.5 rounded bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 font-medium tracking-wide uppercase">
                                    {{ c.integration_name }}
                                </span>
                            </div>
                        </div>
                    </div>
                </button>

                <div *ngIf="filteredCases.length === 0"
                    class="flex flex-col items-center justify-center py-12 text-center px-6">
                    <div
                        class="h-12 w-12 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-3">
                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-900 dark:text-white">Sin resultados</p>
                    <p class="text-xs text-gray-500 mt-1">Intenta con otro tÃ©rmino de bÃºsqueda.</p>
                </div>
            </ng-container>

            <ng-template #leftLoading>
                <div class="p-6 text-sm text-gray-500 dark:text-gray-400">Cargando conversacionesâ€¦</div>
            </ng-template>
        </div>
    </aside>

    <!-- ========== Columna central: chat ========== -->
    <section class="flex-1 flex flex-col min-w-0 bg-white dark:bg-gray-900">
        <!-- Header del chat -->
        <div
            class="h-16 px-6 flex items-center justify-between border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 sticky top-0 z-10">

            <div class="flex items-center gap-3 overflow-hidden">
                <!-- Ãcono canal -->
                <img *ngIf="selectedCase" [src]="channelIcon(selectedCase.channel_code || '')"
                    class="h-10 w-10 rounded-full bg-gray-50 p-1.5 border border-gray-200 dark:border-gray-700 object-cover shrink-0" />

                <div class="flex flex-col min-w-0">
                    <div class="flex items-center gap-2">
                        <span class="text-base font-bold text-gray-900 dark:text-white truncate">
                            {{ selectedCase?.client_name || 'Selecciona una conversaciÃ³n' }}
                        </span>
                        <span *ngIf="selectedCase?.sender_id"
                            class="text-xs text-gray-500 dark:text-gray-400 font-medium px-1.5 py-0.5 bg-gray-100 dark:bg-gray-800 rounded">
                            {{ selectedCase?.sender_id }}
                        </span>
                    </div>

                    <div *ngIf="selectedCase"
                        class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        Caso #{{ selectedCase.case_id }} Â· {{ selectedCase.status | titlecase }}
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div *ngIf="selectedCase" class="flex items-center gap-2">
                <button id="case-button" (click)="viewCase()" class="chip-btn flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Caso
                </button>
                <button class="chip-btn" (click)="toggleRightPanel()">
                    {{ isRightPanelOpen ? 'Ocultar info' : 'Ver info' }}
                </button>
            </div>

        </div>


        <!-- Mensajes -->
        <div class="flex-1 chat-scrollbox overflow-y-auto px-4 py-6 space-y-4 bg-gray-50 dark:bg-gray-900/50">

            <ng-container *ngIf="selectedCase; else emptyState">
                <ng-container *ngIf="!isLoadingMessages; else loadingMessages">
                    <!-- ðŸ”„ Loop de mensajes -->
                    <div *ngFor="let m of messages" class="w-full flex" [class.justify-end]="isFromAgent(m)"
                        [class.justify-start]="!isFromAgent(m)">

                        <div class="max-w-[75%] px-4 py-3 shadow-sm transition-all message-bubble animate-in relative group"
                            [class.bg-[#3e66ea]]="isFromAgent(m)" [class.text-white]="isFromAgent(m)"
                            [class.rounded-2xl]="true" [class.rounded-tr-sm]="isFromAgent(m)"
                            [class.rounded-tl-sm]="!isFromAgent(m)" [class.bg-white]="!isFromAgent(m)"
                            [class.dark:bg-gray-800]="!isFromAgent(m)" [class.border]="!isFromAgent(m)"
                            [class.border-gray-200]="!isFromAgent(m)" [class.dark:border-gray-700]="!isFromAgent(m)"
                            [class.text-gray-900]="!isFromAgent(m)" [class.dark:text-gray-100]="!isFromAgent(m)"
                            [class.animate-in]="m._justArrived">

                            <!-- Texto -->
                            <div *ngIf="isText(m) && m.text_content?.trim()?.length"
                                class="text-sm whitespace-pre-wrap break-words leading-relaxed"
                                [innerHTML]="parseUrls(m.text_content || '')">
                            </div>

                            <!-- Adjuntos -->
                            <div *ngIf="isMedia(m)" class="text-sm">

                                <!-- Imagen -->
                                <ng-container *ngIf="m.message_type === 'image'">
                                    <!-- IMAGEN -->
                                    <div *ngIf="m.message_type === 'image'" class="cursor-pointer"
                                        (click)="openAttachment(m)">
                                        <img [src]="attachmentImageSrc(m)"
                                            class="rounded-lg max-h-72 object-cover border border-black/10"
                                            alt="Imagen" />
                                        <div class="text-xs mt-2 break-words opacity-90" *ngIf="m.text_content">
                                            {{ m.text_content }}
                                        </div>
                                    </div>
                                </ng-container>

                                <!-- Audio -->
                                <ng-container *ngIf="m.message_type === 'audio'">
                                    <div class="flex items-center gap-2 mb-2 opacity-80">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                        </svg>
                                        <span class="text-xs">Nota de voz</span>
                                    </div>

                                    <audio [src]="attachmentAudioSrc(m)" controls
                                        class="w-full min-w-[240px] max-w-full h-10 rounded-lg shadow-sm">
                                    </audio>

                                    <div *ngIf="m.text_content" class="mt-2 opacity-90 whitespace-pre-wrap">
                                        {{ m.text_content }}
                                    </div>
                                </ng-container>

                                <!-- Otros archivos -->
                                <ng-container *ngIf="m.message_type !== 'image'
                              && m.message_type !== 'audio'
                              && m.message_type !== 'text'">
                                    <div
                                        class="flex items-center gap-3 p-3 rounded-lg bg-black/5 dark:bg-white/5 border border-black/5 dark:border-white/5">
                                        <div class="p-2 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                                            <svg class="w-6 h-6 text-gray-500 dark:text-gray-300" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="text-xs font-medium truncate opacity-90">Archivo adjunto</div>
                                            <a (click)="downloadFile(m)"
                                                class="text-xs underline cursor-pointer hover:opacity-80 truncate block">
                                                Descargar
                                            </a>
                                        </div>
                                    </div>

                                    <div *ngIf="m.text_content" class="mt-2 opacity-90 whitespace-pre-wrap">
                                        {{ m.text_content }}
                                    </div>
                                </ng-container>

                            </div>

                            <div class="mt-1 flex items-center justify-end gap-1 opacity-70 select-none">
                                <span class="text-[10px]">
                                    {{ m.created_at | date:'shortTime' }}
                                </span>

                                <!-- Status Icons (only for agent/system messages) -->
                                <ng-container *ngIf="isFromAgent(m)">
                                    <!-- Pending / Null / Empty -> Clock -->
                                    <svg *ngIf="!m.status" xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>

                                    <!-- Delivered -> Single Check -->
                                    <svg *ngIf="m.status === 'delivered' || m.status === 'sent'"
                                        xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>

                                    <!-- Read -> Double Check (Blue) -->
                                    <svg *ngIf="m.status === 'read'" xmlns="http://www.w3.org/2000/svg"
                                        class="h-3.5 w-3.5 text-blue-200" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M16 6L9 13L6.5 10.5M21 6L14 13L11.5 10.5" />
                                    </svg>

                                    <!-- Failed -> Error -->
                                    <svg *ngIf="m.status === 'failed' || m.status === 'fail'"
                                        xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-red-300" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </ng-container>
                            </div>

                            <!-- Error -->
                            <div *ngIf="m.has_error"
                                class="absolute -left-8 top-1/2 -translate-y-1/2 flex items-center justify-center cursor-pointer group">

                                <div class="p-1 rounded-full bg-red-100 hover:bg-red-200 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                        class="w-5 h-5 text-red-600">
                                        <path fill-rule="evenodd"
                                            d="M12 2c-.38 0-.73.21-.9.55L1.18 20.4c-.18.33-.17.73.02 1.05.2.32.54.55.92.55h19.78c.38 0 .72-.23.92-.55.19-.32.2-.72.02-1.05L12.9 2.55A1 1 0 0 0 12 2Zm0 6c.55 0 1 .45 1 1v4a1 1 0 1 1-2 0V9c0-.55.45-1 1-1Zm1 10a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>

                                <!-- Tooltip -->
                                <div
                                    class="hidden group-hover:block absolute left-full ml-2 top-1/2 -translate-y-1/2 z-50 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg">
                                    {{ m.message_error }}
                                </div>
                            </div>

                        </div>
                    </div>

                </ng-container>
            </ng-container>

            <ng-template #loadingMessages>
                <div class="flex items-center justify-center h-full">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#3e66ea]"></div>
                </div>
            </ng-template>

            <ng-template #emptyState>
                <div class="h-full w-full flex flex-col items-center justify-center text-gray-500 dark:text-gray-400">

                    <!-- Imagen del empty state -->
                    <div
                        class="w-24 h-24 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-6">
                        <svg class="w-10 h-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </div>

                    <!-- Texto -->
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-1">Tu espacio de mensajerÃ­a</h3>
                    <p class="text-sm text-center px-4 max-w-xs text-gray-500">
                        Selecciona una conversaciÃ³n de la lista para comenzar a chatear.
                    </p>
                </div>
            </ng-template>
        </div>

        @if(selectedCase?.manual_starting_lead && selectedCase?.client_messages === 0) {
        <div
            class="p-4 border-t border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50 flex flex-col gap-3">

            <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
                <svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Esta es una conversaciÃ³n iniciada manualmente (Outbound). Debes enviar una plantilla para
                    iniciar.</span>
            </div>

            <div class="flex items-center gap-2">
                <select [(ngModel)]="selectedTemplate" class="block flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none
                    focus:ring-2 focus:ring-[#3e66ea] focus:border-transparent text-sm text-[#00113f]
                    dark:bg-gray-800 dark:border-gray-600 dark:text-white transition-all">
                    <option [ngValue]="null">{{t('whatsapp_template.select_template')}}</option>
                    <option *ngFor="let t of templates" [ngValue]="t.template_id">
                        {{ t.template_name }} ({{ t.language_code || 'â€”' }})
                    </option>
                </select>

                <button (click)="sendTemplate()" [disabled]="!selectedCase || !selectedTemplate"
                    class="px-6 py-2 rounded-lg text-sm font-semibold text-white bg-[#00113f] hover:bg-[#3e66ea] disabled:opacity-50 transition shadow-sm">
                    Iniciar
                </button>
            </div>
        </div>
        }@else {
        <!-- Caja de texto -->
        @if(selectedCase ) {
        <!-- Input area -->
        <div class="p-4 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 flex items-end gap-2">

            <!-- Botones izquierda -->
            <div class="flex items-center gap-1 mb-1">
                <!-- Templates -->
                <div class="relative">
                    <button (click)="toggleTemplateMenu()"
                        class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors"
                        title="Plantillas">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                        </svg>
                    </button>

                    <!-- Menu Templates -->
                    <div *ngIf="showTemplateMenu"
                        class="absolute bottom-full left-0 mb-2 w-80 bg-white dark:bg-gray-800 shadow-xl rounded-xl border border-gray-200 dark:border-gray-700 p-2 z-50">
                        <div
                            class="flex items-center justify-between px-2 py-1 mb-2 border-b border-gray-100 dark:border-gray-700">
                            <span class="font-semibold text-xs text-gray-500 uppercase tracking-wider">Plantillas</span>
                            <button (click)="toggleTemplateMenu()"
                                class="text-gray-400 hover:text-gray-600">&times;</button>
                        </div>

                        <div class="max-h-64 overflow-y-auto space-y-1">
                            <!-- Loading -->
                            <div *ngIf="templateLoading" class="flex justify-center py-4">
                                <div
                                    class="animate-spin h-4 w-4 border-2 border-blue-500 rounded-full border-t-transparent">
                                </div>
                            </div>
                            <!-- Empty -->
                            <div *ngIf="!templateLoading && templates.length === 0"
                                class="text-center py-4 text-xs text-gray-400">
                                Sin plantillas para este canal.
                            </div>
                            <!-- Items -->
                            <div *ngFor="let t of templates" (click)="sendSelectedTemplate(t)"
                                class="p-2.5 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg cursor-pointer transition-colors">
                                <div class="text-sm text-gray-800 dark:text-gray-100 font-medium">
                                    {{ t.description || t.template_name }}
                                </div>
                                <div class="text-xs text-gray-400 mt-0.5">{{ t.language_code }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Archivo -->
                <button (click)="openFilePicker()"
                    class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors"
                    title="Adjuntar archivo">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                    </svg>
                </button>

                <!-- Imagen -->
                <button (click)="openImageModal()"
                    class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors"
                    title="Imagen">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </button>
            </div>

            <!-- Input Principal -->
            <div class="flex-1 relative">
                <textarea [(ngModel)]="draft" (keydown.enter)="send()" [disabled]="!selectedCase" rows="1"
                    placeholder="Escribe un mensajeâ€¦" class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800
                           focus:ring-2 focus:ring-[#3e66ea]/50 focus:border-[#3e66ea] focus:bg-white dark:focus:bg-gray-800
                           text-sm text-gray-900 dark:text-white placeholder-gray-400
                           resize-none shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                </textarea>

                <!-- BotÃ³n audio absoluto derecha input -->
                <button (click)="startAudioRecording()"
                    class="absolute right-2 bottom-2 p-1.5 text-gray-400 hover:text-[#3e66ea] rounded-full hover:bg-blue-50 dark:hover:bg-gray-700 transition-colors"
                    title="Grabar audio">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>
            </div>

            <!-- BotÃ³n enviar -->
            <button (click)="send()" [disabled]="!selectedCase || !draft.trim()"
                class="mb-1 p-3 rounded-xl bg-[#3e66ea] hover:bg-blue-600 text-white shadow-lg shadow-blue-500/30 transition-all disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed">
                <svg class="w-5 h-5 translate-x-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>

        </div>
        }
        }
    </section>

    <!-- ========== Columna derecha: adjuntos (colapsable) ========== -->
    <aside
        class="hidden lg:flex flex-col border-l border-gray-200 dark:border-gray-800 transition-all duration-300 ease-in-out bg-white dark:bg-gray-900"
        [style.width.px]="isRightPanelOpen ? 320 : 0" [style.minWidth.px]="isRightPanelOpen ? 320 : 0"
        [style.opacity]="isRightPanelOpen ? 1 : 0" [class.overflow-hidden]="!isRightPanelOpen">

        <div class="h-16 flex items-center px-6 border-b border-gray-200 dark:border-gray-800">
            <h3 class="font-bold text-gray-900 dark:text-white">InformaciÃ³n</h3>
        </div>

        <div class="p-6 border-b border-gray-200 dark:border-gray-800">
            <!-- Info del cliente duplicada para mayor contexto -->
            <div class="flex flex-col items-center text-center">
                <div
                    class="h-20 w-20 rounded-full bg-gray-100 dark:bg-gray-800 text-2xl font-bold flex items-center justify-center text-gray-400 mb-3">
                    {{ (selectedCase?.client_name || '?').charAt(0) }}
                </div>
                <h4 class="font-bold text-lg text-gray-900 dark:text-white mb-1">
                    {{ selectedCase?.client_name || 'Desconocido' }}
                </h4>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                    {{ selectedCase?.sender_id || 'Sin telÃ©fono' }}
                </p>

                <div class="w-full grid grid-cols-2 gap-2 text-center">
                    <div class="p-2 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700">
                        <div class="text-[10px] uppercase text-gray-500 font-semibold tracking-wider">Estado</div>
                        <div class="text-sm font-medium text-gray-900 dark:text-white mt-1">{{ selectedCase?.status ||
                            'â€”' }}</div>
                    </div>
                    <div class="p-2 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700">
                        <div class="text-[10px] uppercase text-gray-500 font-semibold tracking-wider">Creado</div>
                        <div class="text-sm font-medium text-gray-900 dark:text-white mt-1">{{ selectedCase?.created_at
                            | date:'dd/MM' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <div class="px-6 py-4">
                <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Adjuntos recientes</h4>

                <ng-container *ngIf="selectedCase; else noCase">
                    <div *ngIf="attachmentList.length === 0" class="text-sm text-gray-500 dark:text-gray-400 italic">
                        No hay archivos compartidos.
                    </div>

                    <div class="space-y-3">
                        <button *ngFor="let a of attachmentList" (click)="openAttachment(a)"
                            class="w-full text-left p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 flex items-start gap-3 transition-colors group">

                            <!-- Thumbnail -->
                            <div
                                class="relative shrink-0 w-10 h-10 rounded bg-gray-100 dark:bg-gray-700 overflow-hidden border border-gray-200 dark:border-gray-600 flex items-center justify-center text-gray-400">
                                <img *ngIf="a.mime_type?.startsWith('image/')" [src]="attachmentImageSrc(a)"
                                    class="w-full h-full object-cover">
                                <svg *ngIf="!a.mime_type?.startsWith('image/')" class="w-5 h-5" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v15a2 2 0 002 2z" />
                                </svg>
                            </div>

                            <div class="flex-1 min-w-0">
                                <div
                                    class="text-sm font-medium text-gray-900 dark:text-white truncate group-hover:text-blue-600 transition-colors">
                                    {{ a.text_content || 'Archivo' }}
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 truncate mt-0.5">
                                    {{ a.created_at | date:'mediumDate' }}
                                </div>
                            </div>
                        </button>
                    </div>
                </ng-container>
            </div>

            <ng-template #noCase>
                <div class="text-sm text-gray-500 dark:text-gray-400">Sin conversaciÃ³n seleccionada.</div>
            </ng-template>
        </div>
    </aside>

</div>

<!-- ========== Modal de adjunto ========== -->
<div *ngIf="isAttachmentModalOpen" class="fixed inset-0 z-50" (click)="closeAttachmentModal()">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>

    <!-- Contenedor del modal (centrado) -->
    <div class="absolute inset-0 flex items-center justify-center p-4" (click)="$event.stopPropagation()">
        <!-- Caja del modal con altura limitada y layout en columna -->
        <div
            class="modal-box bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden border border-gray-200 dark:border-gray-700">

            <!-- Header -->
            <div class="px-4 py-3 flex items-center gap-2 border-b border-gray-200 dark:border-gray-700">
                <div class="text-sm font-semibold text-[#00113f] dark:text-white flex-1 truncate">
                    Adjunto
                </div>

                <button type="button" *ngIf="viewingAttachment?.message_type === 'image'" class="chip-btn"
                    (click)="openImageInNewTab(viewingAttachment!)">
                    Abrir
                </button>

                <a *ngIf="attachmentImageSrc(viewingAttachment!) && viewingAttachment?.message_type === 'image'"
                    class="chip-btn" [href]="attachmentImageSrc(viewingAttachment!)" download="adjunto"
                    (click)="$event.stopPropagation()">
                    Descargar
                </a>

                <!-- NavegaciÃ³n entre imÃ¡genes -->
                <ng-container *ngIf="viewingAttachment?.message_type === 'image' && imageAttachments.length > 1">
                    <button type="button" class="chip-btn" (click)="prevAttachment()" title="Anterior (â†)">â€¹</button>
                    <span class="text-xs text-gray-500 dark:text-gray-400 tabular-nums">
                        {{ viewingIndex + 1 }} / {{ imageAttachments.length }}
                    </span>
                    <button type="button" class="chip-btn" (click)="nextAttachment()" title="Siguiente (â†’)">â€º</button>
                </ng-container>

                <button type="button" class="chip-btn" (click)="closeAttachmentModal()">
                    Cerrar
                </button>


            </div>

            <!-- Cuerpo: dos columnas con Ã¡rea de scroll propia -->
            <div class="modal-body flex-1 min-h-0 flex flex-col lg:flex-row">

                <!-- Panel de imagen -->
                <div
                    class="viewer-pane lg:w-2/3 border-b lg:border-b-0 lg:border-r border-gray-200 dark:border-gray-700 flex flex-col min-h-0">
                    <!-- Toolbar secundaria -->
                    <div *ngIf="viewingAttachment?.message_type === 'image'"
                        class="px-3 py-2 flex items-center gap-2 border-b border-gray-100 dark:border-gray-700 bg-gray-50/60 dark:bg-gray-900/40">
                        <span class="text-xs text-gray-500 dark:text-gray-400 flex-1 truncate">
                            {{ viewingAttachment?.mime_type || 'image' }}
                        </span>

                        <button type="button" class="chip-btn" (click)="zoomOut()"
                            [disabled]="zoomLevel <= 0.4">âˆ’</button>
                        <span class="text-xs w-12 text-center text-gray-600 dark:text-gray-300">
                            {{ (zoomLevel * 100) | number:'1.0-0' }}%
                        </span>
                        <button type="button" class="chip-btn" (click)="zoomIn()" [disabled]="zoomLevel >= 4">+</button>

                        <button type="button" class="chip-btn" (click)="toggleFit()">
                            {{ fitToScreen ? 'Ajuste: Pantalla' : 'Ajuste: Original' }}
                        </button>
                        <button type="button" class="chip-btn" (click)="resetZoom()">Restablecer</button>
                    </div>

                    <!-- Ãrea desplazable fija -->
                    <div *ngIf="viewingAttachment?.message_type === 'image'"
                        class="viewer-scroll flex-1 min-h-0 overflow-auto bg-gray-100 dark:bg-gray-900 relative">
                        <!-- Skeleton -->
                        <div *ngIf="!imageLoaded" class="absolute inset-0 flex items-center justify-center">
                            <div class="animate-pulse w-24 h-24 rounded-lg bg-gray-200 dark:bg-gray-700"></div>
                        </div>

                        <div class="flex items-center justify-center min-h-full">
                            <img *ngIf="viewingAttachment?.message_type === 'image'"
                                [src]="attachmentImageSrc(viewingAttachment!)" alt="imagen-adjunto"
                                (load)="onImageLoad()" (error)="onImageError()" [class.object-contain]="fitToScreen"
                                [class.object-none]="!fitToScreen"
                                class="select-none rounded transition-transform duration-150 ease-out max-w-none"
                                [style.transform]="'scale(' + zoomLevel + ')'" [style.transformOrigin]="'center center'"
                                [style.maxWidth]="fitToScreen ? '100%' : 'none'"
                                [style.maxHeight]="fitToScreen ? '100%' : 'none'" draggable="false" />

                        </div>

                    </div>

                    <!-- Audios -->

                    <ng-container *ngIf="viewingAttachment?.message_type === 'audio'">
                        <div class="w-full mt-6 bg-[#E9F0FA] p-5 rounded-xl shadow-inner">
                            <audio [src]="attachmentAudioSrc(viewingAttachment)" controls
                                class="w-full min-w-[260px] max-w-full h-12 rounded-lg bg-white shadow"></audio>
                        </div>
                    </ng-container>

                    <!-- ðŸ“• PDF (es un file, pero con mime de PDF) -->
                    <ng-container *ngIf="viewingAttachment?.message_type === 'file' && isPdf(viewingAttachment)">
                        <iframe [src]="safeAttachmentSrc(viewingAttachment)"
                            class="w-full h-[85vh] rounded shadow bg-white" frameborder="0">
                        </iframe>
                    </ng-container>

                    <!-- ðŸ“„ ARCHIVOS GENERALES (no PDF) -->
                    <ng-container *ngIf="viewingAttachment?.message_type === 'file' && !isPdf(viewingAttachment)">
                        <div class="flex flex-col items-center justify-center w-full py-10 text-center">
                            <div class="text-6xl mb-4">ðŸ“„</div>

                            <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
                                {{ viewingAttachment?.text_content || 'Archivo adjunto'
                                }}
                            </p>

                            <button (click)="downloadFile(viewingAttachment!)"
                                class="px-4 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700">
                                Descargar / Abrir archivo
                            </button>
                        </div>
                    </ng-container>


                </div>

                <!-- Panel lateral: caption/metadata -->
                <div
                    class="lg:w-1/3 p-4 overflow-auto bg-gray-50 dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800">
                    <div class="space-y-4">
                        <div class="text-sm font-semibold text-[#00113f] dark:text-white">
                            Detalles del adjunto
                        </div>

                        <div
                            class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-3 shadow-sm">
                            <div class="text-xs text-gray-500 dark:text-gray-400">Tipo</div>
                            <div class="text-sm text-[#00113f] dark:text-gray-200 font-medium">
                                {{ viewingAttachment?.message_type | uppercase }}
                                <span class="text-xs text-gray-400 font-normal">({{ viewingAttachment?.mime_type || 'â€”'
                                    }})</span>
                            </div>
                        </div>

                        <div
                            class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-3 shadow-sm">
                            <div class="text-xs text-gray-500 dark:text-gray-400">Fecha</div>
                            <div class="text-sm text-[#00113f] dark:text-gray-200 font-medium">
                                {{ viewingAttachment?.created_at | date:'medium' }}
                            </div>
                        </div>

                        <!-- Caption -->
                        <div
                            class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-3 shadow-sm">
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Nota / Caption</div>
                            <div class="text-sm text-[#00113f] dark:text-gray-100 whitespace-pre-wrap break-words"
                                *ngIf="(viewingAttachment?.text_content || '').trim().length > 0; else noCaption">
                                {{ viewingAttachment?.text_content }}
                            </div>
                            <ng-template #noCaption>
                                <div class="text-xs text-gray-400 italic">â€” Sin nota â€”</div>
                            </ng-template>
                        </div>

                        <div *ngIf="viewingAttachment?.file_url"
                            class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-3 shadow-sm">
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Enlace</div>
                            <a [href]="viewingAttachment?.file_url || undefined" target="_blank" rel="noopener"
                                class="text-[#3e66ea] hover:underline break-all text-sm">
                                {{ viewingAttachment?.file_url }}
                            </a>
                        </div>
                    </div>
                </div>

            </div>
            <!-- /Cuerpo -->
        </div>
    </div>
</div>

}

<!-- ========== Modal de PrevisualizaciÃ³n de PDF ========== -->
<div *ngIf="isPdfPreviewOpen" class="fixed inset-0 z-[60]" (click)="closePdfPreview()">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>

    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 w-full max-w-6xl h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-gray-200 dark:border-gray-700"
            (click)="$event.stopPropagation()">

            <!-- Header -->
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
                <div class="flex items-center gap-3 overflow-hidden">
                    <span class="p-2 bg-red-100 text-red-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v15a2 2 0 002 2z" />
                        </svg>
                    </span>
                    <div class="flex flex-col min-w-0">
                        <span class="text-sm font-bold text-gray-900 dark:text-gray-100 truncate max-w-md"
                            title="{{currentPdfFilename}}">
                            {{ currentPdfFilename || 'Documento PDF' }}
                        </span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">Vista previa</span>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <!-- <button (click)="downloadCurrentPdf()"
                        class="flex items-center gap-2 px-4 py-2 bg-[#00113f] hover:bg-[#3e66ea] text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Descargar
                    </button> -->

                    <button (click)="closePdfPreview()"
                        class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Body -->
            <div class="flex-1 bg-gray-100 dark:bg-gray-800 relative">
                <iframe *ngIf="pdfPreviewSafeUrl" [src]="pdfPreviewSafeUrl"
                    class="absolute inset-0 w-full h-full border-0" title="PDF Preview">
                </iframe>
            </div>
        </div>
    </div>
</div>

@if (isCaseMode) {
<div class="h-[calc(100vh-2rem)] w-full bg-white dark:bg-gray-900 rounded-xl shadow-lg overflow-hidden flex">
    <section class="flex-1 flex flex-col min-w-0">

        <!-- Header (alineado y con el mismo margen visual que â€œConversacionesâ€) -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-800">
            <div class="flex items-center gap-2">
                <button type="button"
                    class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300"
                    (click)="isCaseMode = false" aria-label="Regresar" title="Regresar">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>

                <div class="text-base font-semibold text-[#00113f] dark:text-white">
                    Tarjeta del caso
                </div>
            </div>
        </div>

        <!-- Contenido -->
        <div class="flex-1 overflow-y-auto p-4">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

                <!-- Columna izquierda (2/3) -->
                <div class="lg:col-span-2 space-y-4">
                    <!-- Resumen del caso -->
                    <div
                        class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm">
                        <div
                            class="p-4 border-b border-gray-100 dark:border-gray-800 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <img [src]="selectedCase ? channelIcon(selectedCase.channel_code || '') : 'assets/icons/default-channel.svg'"
                                    class="h-9 w-9 rounded-md bg-white p-1 shadow-sm" alt="canal" />
                                <div>
                                    <div class="text-sm font-semibold text-[#00113f] dark:text-white">
                                        Caso #{{ selectedCase?.case_id }}
                                    </div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">
                                        {{ selectedCase?.client_name || 'Cliente no asignado' }}
                                    </div>
                                </div>
                            </div>


                            <div class="flex items-center gap-2">
                                @if(selectedCase?.unread_count ) {
                                <span
                                    class="px-2 py-1 text-xs font-bold text-red-600 bg-red-100 rounded-full flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-red-600"></span>
                                    {{ selectedCase?.unread_count }} sin leer
                                </span>
                                }
                                <span class="px-2 py-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-full">
                                    {{ selectedCase?.status | uppercase }}
                                </span>
                            </div>
                        </div>

                        <!-- Detalles rÃ¡pidos -->
                        <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Lead ID /
                                    Sender</span>
                                <div class="font-medium text-[#00113f] dark:text-gray-200">
                                    {{ selectedCase?.sender_id || 'â€”' }}
                                </div>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Fecha de
                                    creaciÃ³n</span>
                                <div class="font-medium text-[#00113f] dark:text-gray-200">
                                    {{ selectedCase?.created_at | date:'medium' }}
                                </div>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Canal</span>
                                <div class="font-medium text-[#00113f] dark:text-gray-200 flex items-center gap-1">
                                    {{ selectedCase?.channel_code || 'â€”' }}
                                    <span *ngIf="selectedCase?.integration_name" class="text-xs text-gray-400">
                                        ({{ selectedCase?.integration_name }})
                                    </span>
                                </div>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ãšltima
                                    interacciÃ³n</span>
                                <div class="font-medium text-[#00113f] dark:text-gray-200">
                                    {{ selectedCase?.last_message_at | date:'short' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notas del Caso -->
                    <div
                        class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 flex flex-col h-[400px]">
                        <div
                            class="p-3 border-b border-gray-200 dark:border-gray-800 font-semibold text-gray-700 dark:text-gray-200">
                            Notas internas
                        </div>

                        <div class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50 dark:bg-gray-900/50">
                            <div *ngIf="isLoadingNotes" class="flex justify-center py-4">
                                <div
                                    class="animate-spin h-5 w-5 border-2 border-blue-500 rounded-full border-t-transparent">
                                </div>
                            </div>

                            <div *ngIf="!isLoadingNotes && notes.length === 0"
                                class="text-center py-8 text-gray-400 text-sm">
                                No hay notas aÃºn.
                            </div>

                            <div *ngFor="let n of notes"
                                class="bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700">
                                <div class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap mb-1">{{ n.note
                                    }}</div>
                                <div class="text-xs text-gray-400 flex justify-between items-center">
                                    <span>{{ n.author_name || 'Agente' }}</span>
                                    <span>{{ n.created_at | date:'short' }}</span>
                                </div>
                            </div>
                        </div>

                        <div
                            class="p-3 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 rounded-b-xl">
                            <textarea [(ngModel)]="newNote" rows="2"
                                class="w-full text-sm p-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none resize-none mb-2"
                                placeholder="Escribe una nota..."></textarea>
                            <div class="flex justify-end">
                                <button (click)="addNote()" [disabled]="!newNote.trim() || isSavingNote"
                                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1">
                                    <span *ngIf="isSavingNote"
                                        class="animate-spin h-3 w-3 border-2 border-white rounded-full border-t-transparent"></span>
                                    Agregar nota
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Columna derecha (1/3) -->
                <div class="space-y-4">
                    <!-- Acciones rÃ¡pidas -->
                    <div
                        class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-4">
                        <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Acciones</h4>
                        <div class="flex flex-col gap-2">
                            <button (click)="isCaseMode = false"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 text-sm font-medium text-blue-600 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                                Ir al chat
                            </button>
                            <button (click)="closeCase()"
                                class="w-full text-left px-3 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-sm font-medium text-red-600 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7" />
                                </svg>
                                Cerrar caso (Resolver)
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>
</div>
}

<!-- ========== Modals ========== -->

<!-- Modal Client Form -->
<app-client-form *ngIf="isFormOpen" [client]="currentClient" (cancel)="closeDialog()" (success)="onSuccess($event)">
</app-client-form>

<!-- Modal Move Stage -->
<app-move-stage-modal *ngIf="isMoveStageOpen" [current]="currentStage!" [caseId]="selectedCase?.case_id!"
    [funnelId]="selectedCase?.funnel_id!" (cancel)="closeMoveStageModal()" (moved)="onMoveStage($event)">
</app-move-stage-modal>

<!-- Modal Send Image -->
<app-send-image-modal *ngIf="isImageModalOpen" (close)="closeImageModal()" (send)="onSendImage($event)">
</app-send-image-modal>

<!-- Modal Send File -->
<app-send-file-modal *ngIf="isFileModalOpen" (close)="closeFileModal()" (send)="onSendFile($event)">
</app-send-file-modal>

<!-- Audio Recorder -->
<app-audio-recorder *ngIf="isAudioModalOpen" (cancel)="closeAudioModal()" (send)="onSendAudio($event)">
</app-audio-recorder>


<!-- Modal Close Case -->
<div *ngIf="isCloseCaseOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
    (click)="closeCloseCaseModal()">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md p-6 m-4"
        (click)="$event.stopPropagation()">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Cerrar Caso</h3>

        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
            Â¿EstÃ¡s seguro de que deseas cerrar este caso? Puedes agregar una nota final opcional.
        </p>

        <textarea [(ngModel)]="closeNote"
            class="w-full h-24 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none resize-none mb-4"
            placeholder="Nota de cierre (opcional)..."></textarea>

        <div class="flex items-center justify-end gap-3">
            <button (click)="closeCloseCaseModal()"
                class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                Cancelar
            </button>
            <button (click)="confirmCloseCase()" [disabled]="isClosingCase"
                class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow-sm transition-colors flex items-center gap-2">
                <svg *ngIf="isClosingCase" class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                {{ isClosingCase ? 'Cerrando...' : 'Cerrar Caso' }}
            </button>
        </div>
    </div>
</div>

<!-- Modal Nueva ConversaciÃ³n -->
<div *ngIf="isNewConversationOpen"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
    (click)="isNewConversationOpen = false">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-lg p-6 m-4 flex flex-col max-h-[85vh]"
        (click)="$event.stopPropagation()">

        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Nueva ConversaciÃ³n</h3>
            <button (click)="isNewConversationOpen = false"
                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto space-y-4 px-4 py-2 custom-scrollbar">
            <!-- Buscar Cliente -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buscar Cliente
                    (Opcional)</label>
                <input type="text" [(ngModel)]="newConvClientSearch" (ngModelChange)="searchNewConvClient()"
                    placeholder="Escribe el nombre o telÃ©fono..."
                    class="w-full p-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">

                <!-- Resultados bÃºsqueda -->
                <div *ngIf="newConvClientResults.length > 0"
                    class="mt-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                    <div *ngFor="let c of newConvClientResults"
                        (click)="selectNewConvClient(c); newConvClientResults = []"
                        class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer text-sm text-gray-700 dark:text-gray-200">
                        {{ c.full_name }} <span class="text-xs text-gray-400">({{ c.phone }})</span>
                    </div>
                </div>
                <!-- Cliente seleccionado -->
                <div *ngIf="newConvSelectedClient"
                    class="mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded text-sm text-blue-800 dark:text-blue-200 flex justify-between items-center">
                    <span>Cliente: <strong>{{ newConvSelectedClient.full_name }}</strong></span>
                    <button (click)="newConvSelectedClient = null; newConvPhone = ''"
                        class="text-blue-600 hover:text-blue-800 dark:hover:text-blue-300 text-xs">Desvincular</button>
                </div>
            </div>

            <!-- TelÃ©fono Destino -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    TelÃ©fono Destino <span class="text-red-500">*</span>
                </label>
                <div class="flex gap-2">
                    <!-- CÃ³digo de paÃ­s -->
                    <div class="flex-shrink-0 w-24">
                        <div class="relative">
                            <span
                                class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-medium select-none">+</span>
                            <input type="text" [(ngModel)]="newConvCountryCode" (input)="onPhoneInput()"
                                placeholder="506" maxlength="4"
                                class="w-full pl-6 pr-2 py-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none text-center font-mono">
                        </div>
                    </div>
                    <!-- NÃºmero local -->
                    <input type="text" [(ngModel)]="newConvPhone" (input)="onPhoneInput()" placeholder="Ej: 88888888"
                        class="flex-1 p-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none font-mono">
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    NÃºmero completo: <span class="font-mono font-medium text-gray-700 dark:text-gray-300">{{
                        newConvCountryCode }}{{ newConvPhone }}</span>
                </p>
            </div>

            <!-- SelecciÃ³n de IntegraciÃ³n -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Canal de Salida <span
                        class="text-red-500">*</span></label>
                <select [(ngModel)]="selectedIntegration" (ngModelChange)="onIntegrationChange()"
                    class="w-full p-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    <option [ngValue]="null" disabled>Selecciona un canal</option>
                    <option *ngFor="let i of integrations" [ngValue]="i">
                        {{ i.integration_name }} ({{ i.channel_name }})
                    </option>
                </select>
            </div>


            <!-- SelecciÃ³n de Template (Dropdown) -->
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Template Inicial <span class="text-red-500">*</span>
                </label>

                <!-- Trigger button -->
                <button type="button" (click)="isTemplateDropdownOpen = !isTemplateDropdownOpen"
                    [disabled]="!selectedIntegration"
                    class="w-full flex items-center justify-between p-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-left focus:ring-2 focus:ring-blue-500 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    [class.border-blue-500]="isTemplateDropdownOpen">

                    <span *ngIf="!newConvSelectedTemplate" class="text-gray-400 dark:text-gray-400">
                        {{ selectedIntegration ? 'Selecciona una plantilla...' : 'Selecciona primero un canal' }}
                    </span>
                    <span *ngIf="newConvSelectedTemplate" class="text-gray-900 dark:text-white font-medium truncate">
                        {{ newConvSelectedTemplate.description || newConvSelectedTemplate.template_name }}
                        <span class="text-xs font-normal text-gray-400 ml-1">Â· {{ newConvSelectedTemplate.language_code
                            }}</span>
                    </span>

                    <!-- Chevron -->
                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0 ml-2 transition-transform duration-200"
                        [class.rotate-180]="isTemplateDropdownOpen" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                <!-- Dropdown panel -->
                <div *ngIf="isTemplateDropdownOpen"
                    class="mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl overflow-hidden">

                    <!-- Loading -->
                    <div *ngIf="templateLoading" class="flex justify-center items-center py-6">
                        <div class="animate-spin h-5 w-5 border-2 border-blue-500 rounded-full border-t-transparent">
                        </div>
                    </div>

                    <!-- Empty -->
                    <div *ngIf="!templateLoading && newConvTemplates.length === 0"
                        class="text-center py-6 text-gray-500 text-sm">
                        No hay plantillas disponibles para este canal.
                    </div>

                    <!-- Template cards -->
                    <div *ngIf="!templateLoading && newConvTemplates.length > 0"
                        class="max-h-56 overflow-y-auto custom-scrollbar p-2 space-y-1">
                        <div *ngFor="let t of newConvTemplates"
                            (click)="newConvSelectedTemplate = t; isTemplateDropdownOpen = false"
                            class="relative p-3 rounded-lg border-2 cursor-pointer transition-all duration-150 group"
                            [class.border-blue-500]="newConvSelectedTemplate?.template_id === t.template_id"
                            [class.bg-blue-50]="newConvSelectedTemplate?.template_id === t.template_id"
                            [class.dark:bg-blue-900\/20]="newConvSelectedTemplate?.template_id === t.template_id"
                            [class.border-transparent]="newConvSelectedTemplate?.template_id !== t.template_id"
                            [class.hover:bg-gray-50]="newConvSelectedTemplate?.template_id !== t.template_id"
                            [class.dark:hover:bg-gray-700]="newConvSelectedTemplate?.template_id !== t.template_id">

                            <div class="flex justify-between items-center gap-2">
                                <div class="min-w-0">
                                    <div
                                        class="text-sm font-semibold text-gray-900 dark:text-white truncate
                                                group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                                        {{ t.description || t.template_name }}
                                    </div>
                                    <div class="text-xs text-gray-400 dark:text-gray-500 mt-0.5">
                                        {{ t.language_code }}
                                    </div>
                                </div>
                                <svg *ngIf="newConvSelectedTemplate?.template_id === t.template_id"
                                    class="w-5 h-5 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-gray-100 dark:border-gray-700">
            <button (click)="isNewConversationOpen = false"
                class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                Cancelar
            </button>
            <button (click)="confirmNewConversation()"
                class="px-4 py-2 text-sm font-medium text-white bg-[#00113f] hover:bg-blue-700 rounded-lg shadow-sm transition-colors">
                Iniciar ConversaciÃ³n
            </button>
        </div>
    </div>
</div>