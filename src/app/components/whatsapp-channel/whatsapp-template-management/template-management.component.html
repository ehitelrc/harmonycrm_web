<app-main-layout>
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-semibold text-[#00113f] dark:text-white">
          {{ t('whatsapp_template.management_title') }}
        </h1>
        <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">
          Selecciona un canal para ver sus plantillas y gestionar sus integraciones.
        </p>
      </div>
      <button *ngIf="selectedChannelId" type="button" (click)="openCreateDialog()"
        class="flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#00113f] hover:bg-[#3e66ea] focus:outline-none transition-colors">
        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        {{ t('whatsapp_template.add_new_template') }}
      </button>
    </div>

    <!-- Filtro de Canal -->
    <div class="bg-white dark:bg-gray-800 p-4 shadow rounded-lg">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Canal</label>
      <select [(ngModel)]="selectedChannelId" (ngModelChange)="onChannelChanged()"
        class="block w-full max-w-xs px-3 py-2 border rounded-md text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
        <option [ngValue]="null">-- Selecciona un canal --</option>
        <option *ngFor="let c of channels" [ngValue]="c.id">{{ c.name }}</option>
      </select>
    </div>

    <!-- Layout 2 columnas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Columna izquierda: Lista de templates -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-700 dark:text-white">Plantillas</h2>
          <span class="text-xs text-gray-400">{{ messageTemplates.length }} resultado{{ messageTemplates.length !== 1 ?
            's' : '' }}</span>
        </div>

        <!-- Loading -->
        <div *ngIf="loadingMessageTemplates" class="flex items-center justify-center py-10">
          <svg class="animate-spin h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
          <span class="ml-2 text-sm text-gray-400">Cargando…</span>
        </div>

        <!-- Sin canal -->
        <div *ngIf="!selectedChannelId && !loadingMessageTemplates"
          class="flex flex-col items-center justify-center py-12 text-gray-400 dark:text-gray-500">
          <svg class="h-10 w-10 mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M3 10h18M3 6h18M3 14h18M3 18h18" />
          </svg>
          <p class="text-sm">Selecciona un canal para ver las plantillas</p>
        </div>

        <!-- Sin plantillas -->
        <div *ngIf="selectedChannelId && !loadingMessageTemplates && messageTemplates.length === 0"
          class="flex flex-col items-center justify-center py-12 text-gray-400 dark:text-gray-500">
          <p class="text-sm">No hay plantillas para este canal.</p>
          <button (click)="openCreateDialog()" class="mt-3 text-sm text-blue-600 hover:underline dark:text-blue-400">
            + Crear la primera plantilla
          </button>
        </div>

        <!-- Lista -->
        <ul *ngIf="!loadingMessageTemplates && messageTemplates.length > 0"
          class="divide-y divide-gray-100 dark:divide-gray-700">
          <li *ngFor="let tmpl of messageTemplates" (click)="selectMessageTemplate(tmpl)"
            class="px-4 py-3 flex items-center gap-3 cursor-pointer transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50 group"
            [class.bg-blue-50]="isSelected(tmpl)" [class.dark:bg-blue-900\/20]="isSelected(tmpl)"
            [class.border-l-4]="isSelected(tmpl)" [class.border-blue-600]="isSelected(tmpl)">

            <!-- Dot activo -->
            <span class="flex-shrink-0 h-2 w-2 rounded-full" [class.bg-green-500]="tmpl.is_active"
              [class.bg-gray-300]="!tmpl.is_active">
            </span>

            <!-- Info -->
            <div class="min-w-0 flex-1">
              <p class="text-sm font-medium text-gray-800 dark:text-white truncate">{{ tmpl.template_name }}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                {{ tmpl.category || 'Sin categoría' }} · {{ tmpl.language_code }}
              </p>
            </div>

            <!-- Starter badge -->
            <span *ngIf="tmpl.is_conversation_starter"
              class="text-xs px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 font-medium whitespace-nowrap flex-shrink-0">
              Starter
            </span>

            <!-- Integrations count badge -->
            <span
              class="inline-flex items-center gap-0.5 text-xs px-1.5 py-0.5 rounded-full font-medium whitespace-nowrap flex-shrink-0"
              [class.bg-green-100]="tmpl.linked_count > 0" [class.text-green-700]="tmpl.linked_count > 0"
              [class.dark:bg-green-900]="tmpl.linked_count > 0" [class.dark:text-green-300]="tmpl.linked_count > 0"
              [class.bg-gray-100]="tmpl.linked_count === 0" [class.text-gray-400]="tmpl.linked_count === 0"
              [class.dark:bg-gray-700]="tmpl.linked_count === 0"
              title="{{ tmpl.linked_count }} integración(es) vinculada(s)">
              <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
              </svg>
              {{ tmpl.linked_count }}
            </span>

            <!-- Acciones (visibles al hover) -->
            <div class="flex items-center gap-1 flex-shrink-0">
              <!-- Editar -->
              <button type="button" (click)="openEditDialog(tmpl, $event)" title="Editar plantilla"
                class="p-1.5 rounded hover:bg-blue-100 dark:hover:bg-blue-800 text-gray-400 hover:text-blue-600 dark:hover:text-blue-300 transition-colors">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15.232 5.232l3.536 3.536M9 13l6.293-6.293a1 1 0 011.414 0l1.586 1.586a1 1 0 010 1.414L12 16H9v-3z" />
                </svg>
              </button>
              <!-- Eliminar -->
              <button type="button" (click)="askDelete(tmpl, $event)" title="Eliminar plantilla"
                class="p-1.5 rounded hover:bg-red-100 dark:hover:bg-red-900 text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-colors">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2" />
                </svg>
              </button>
            </div>

            <!-- Chevron -->
            <svg class="flex-shrink-0 h-4 w-4 text-gray-300 group-hover:text-gray-400" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </li>
        </ul>
      </div>

      <!-- Columna derecha: Panel de Integraciones -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
          <h2 class="text-sm font-semibold text-gray-700 dark:text-white">Integraciones vinculadas</h2>
          <p class="text-xs text-gray-400 mt-0.5">
            Activa o desactiva la vinculación con cada integración.
          </p>
        </div>
        <div class="p-4">
          <app-template-integration-panel [template]="selectedMessageTemplate"></app-template-integration-panel>
        </div>
      </div>

    </div>

    <!-- Modal form (crear / editar) -->
    <app-message-template-form *ngIf="isFormOpen" [template]="editingTemplate"
      [preselectedChannelId]="selectedChannelId" (success)="onFormSuccess($event)" (cancel)="closeDialog()">
    </app-message-template-form>

    <!-- Modal de eliminación -->
    <div *ngIf="isDeleteOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black/40" (click)="cancelDelete()"></div>

      <!-- Dialog -->
      <div class="relative z-10 bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm"
        (click)="$event.stopPropagation()">
        <div class="p-6">
          <!-- Icono + texto -->
          <div class="flex items-start gap-4">
            <div
              class="flex-shrink-0 flex items-center justify-center h-11 w-11 rounded-full bg-red-100 dark:bg-red-900">
              <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2" />
              </svg>
            </div>
            <div>
              <h3 class="text-base font-semibold text-gray-900 dark:text-white">Eliminar plantilla</h3>
              <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                Esta acción no se puede deshacer. ¿Estás seguro de que deseas eliminar esta plantilla?
              </p>
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-6 flex justify-end gap-3">
            <button type="button" (click)="cancelDelete()" [disabled]="isDeleting"
              class="px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 disabled:opacity-50 transition-colors">
              Cancelar
            </button>
            <button type="button" (click)="confirmDelete()" [disabled]="isDeleting"
              class="px-4 py-2 text-sm font-medium rounded-lg bg-red-600 text-white hover:bg-red-700 disabled:opacity-50 flex items-center gap-2 transition-colors">
              <svg *ngIf="isDeleting" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
              </svg>
              {{ isDeleting ? 'Eliminando…' : 'Eliminar' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-main-layout>